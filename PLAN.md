# План реализации функций кнопок

## Обзор проекта
Приложение для генерации описаний картин, названий выставок и афиш с использованием AI.

## Порядок действий

### 1. Настройка AI API
- [x] Выбрать AI провайдера (OpenAI GPT-4 Vision / Anthropic Claude / Google Gemini)
- [x] Установить необходимые пакеты (например, `openai` или `@anthropic-ai/sdk`)
- [x] Создать файл `.env.local` для хранения API ключей
- [x] Добавить переменные окружения в `.env.local`:
  - `AI_API_KEY` - ключ API
  - `AI_MODEL` - модель для использования (опционально)

**Выполнено:**
- Выбран провайдер: **OpenRouter AI** (универсальный API для доступа к различным моделям AI)
- Используется нативный `fetch` API (не требуется дополнительных пакетов)
- Endpoint: `https://openrouter.ai/api/v1/chat/completions`
- Создан файл `env.example` с примером конфигурации
- Создана утилита `lib/openrouter.ts` для работы с OpenRouter API
- `.gitignore` уже содержит `.env*.local` для защиты ключей
- **Важно:** Создайте файл `.env.local` вручную на основе `env.example` и добавьте свой API ключ OpenRouter

### 2. Создание API Routes в Next.js

#### 2.1. API Route для генерации описаний (`/api/describe`)
- [x] Создать файл `app/api/describe/route.ts`
- [x] Реализовать обработку POST запроса
- [x] Получить загруженные изображения из FormData
- [x] Конвертировать изображения в base64 или передать в API
- [x] Для каждой картинки:
  - Отправить запрос к AI API с промптом для генерации описания
  - Получить описание картины
- [x] Вернуть массив описаний в формате JSON
- [x] Добавить обработку ошибок

**Выполнено:**
- Создан route с обработкой FormData
- Реализована конвертация изображений в base64
- Последовательная обработка всех изображений
- Промпт на русском языке для детального описания картин
- Обработка ошибок для каждого изображения отдельно

#### 2.2. API Route для генерации названий выставки (`/api/exhibition`)
- [x] Создать файл `app/api/exhibition/route.ts`
- [x] Реализовать обработку POST запроса
- [x] Получить описания картин (из предыдущего шага или сгенерировать заново)
- [x] Отправить совокупный анализ всех описаний к AI API
- [x] Запросить 3 варианта названия выставки
- [x] Вернуть массив из 3 вариантов названий
- [x] Добавить обработку ошибок

**Выполнено:**
- Создан route с обработкой JSON запросов
- Реализован парсинг ответа AI для извлечения 3 вариантов
- Поддержка различных форматов входных данных
- Валидация и обработка ошибок

#### 2.3. API Route для генерации афиши (`/api/poster`)
- [x] Создать файл `app/api/poster/route.ts`
- [x] Реализовать обработку POST запроса
- [x] Получить выбранное название выставки
- [x] Получить изображения картин
- [x] Отправить запрос к AI API для:
  - Генерации макета афиши (текстовое описание или изображение)
  - Генерации краткого описания выставки
- [x] Вернуть объект с макетом афиши и описанием
- [x] Добавить обработку ошибок

**Выполнено:**
- Создан route для генерации афиши
- Реализован парсинг структурированного ответа AI
- Поддержка контекста из описаний картин
- Возврат объекта с макетом и описанием выставки

### 3. Обновление фронтенда

#### 3.1. Функция "Описание" (кнопка "Описание")
- [x] Обновить `handleDescription` в `app/page.tsx`
- [x] Создать FormData с загруженными изображениями
- [x] Отправить POST запрос к `/api/describe`
- [x] Отобразить загрузку во время запроса
- [x] Получить массив описаний
- [x] Отформатировать и отобразить описания в блоке результатов
- [x] Сохранить описания в state для использования в следующих шагах
- [x] Добавить обработку ошибок с уведомлением пользователя

**Выполнено:**
- Реализована отправка FormData с изображениями
- Добавлено состояние для хранения описаний
- Форматирование описаний с названиями файлов
- Обработка ошибок с отображением сообщений

#### 3.2. Функция "Выставка" (кнопка "Выставка")
- [x] Обновить `handleExhibition` в `app/page.tsx`
- [x] Проверить наличие описаний картин (если нет - сначала сгенерировать)
- [x] Отправить POST запрос к `/api/exhibition` с описаниями
- [x] Отобразить загрузку во время запроса
- [x] Получить 3 варианта названий
- [x] Отобразить варианты как кликабельные кнопки
- [x] Реализовать выбор варианта с визуальным выделением
- [x] Сохранить выбранный вариант в state
- [x] Добавить обработку ошибок

**Выполнено:**
- Проверка наличия описаний перед генерацией названий
- Отправка JSON запроса с описаниями
- Отображение вариантов с правильной типизацией (id, title)
- Визуальное выделение выбранного варианта
- Кнопка "Выставка" отключается, если нет описаний

#### 3.3. Функция "Афиша" (кнопка "Афиша")
- [x] Обновить `handlePoster` в `app/page.tsx`
- [x] Проверить наличие выбранного названия выставки
- [x] Создать FormData с изображениями и выбранным названием
- [x] Отправить POST запрос к `/api/poster`
- [x] Отобразить загрузку во время запроса
- [x] Получить макет афиши и описание
- [x] Отобразить макет афиши (если это изображение - показать, если текст - отформатировать)
- [x] Отобразить краткое описание выставки
- [x] Добавить обработку ошибок

**Выполнено:**
- Отправка JSON запроса с названием и описаниями
- Раздельное отображение макета афиши и описания выставки
- Улучшенное форматирование результатов
- Обработка ошибок на всех этапах

### 4. Улучшение UX

#### 4.1. Обработка состояний
- [x] Добавить состояние для хранения описаний картин
- [x] Добавить состояние для отслеживания прогресса генерации
- [x] Улучшить индикаторы загрузки (прогресс-бар, процент выполнения)
- [x] Добавить возможность отмены запросов

**Выполнено:**
- Добавлено состояние `progress` для отслеживания прогресса обработки
- Реализован прогресс-бар с процентами выполнения
- Добавлена кнопка "Отменить" для прерывания запросов
- Использован `AbortController` для отмены fetch запросов
- Отображение количества обработанных файлов

#### 4.2. Валидация
- [x] Проверка формата изображений (только изображения)
- [x] Проверка размера файлов (ограничение размера)
- [x] Проверка количества файлов (максимальное количество)
- [x] Валидация перед отправкой запросов

**Выполнено:**
- Функция `validateImages` проверяет формат, размер и количество файлов
- Максимальный размер файла: 10 MB
- Максимальное количество файлов: 10
- Разрешенные форматы: JPEG, PNG, WebP, GIF
- Валидация выполняется при загрузке файлов
- Отображение размера каждого файла в списке

#### 4.3. Обработка ошибок
- [x] Понятные сообщения об ошибках для пользователя
- [x] Retry механизм для неудачных запросов
- [x] Логирование ошибок для отладки
- [x] Обработка таймаутов

**Выполнено:**
- Функция `fetchWithRetry` с автоматическими повторами (до 2 попыток)
- Экспоненциальная задержка между попытками
- Понятные сообщения об ошибках для пользователя
- Обработка различных типов ошибок (сеть, таймаут, отмена)
- Логирование ошибок в консоль для отладки
- Отображение количества попыток при retry

### 5. Оптимизация и производительность

#### 5.1. Оптимизация изображений
- [x] Сжатие изображений перед отправкой
- [x] Ресайз изображений до разумного размера
- [x] Кэширование результатов генерации

**Выполнено:**
- Создана утилита `lib/imageOptimization.ts` для оптимизации изображений
- Реализована функция `optimizeImage` для сжатия и ресайза:
  - Максимальный размер: 1920x1920 пикселей
  - Максимальный размер файла после сжатия: 500 KB
  - Качество JPEG: 85%
  - Автоматическое уменьшение качества при необходимости
- Функция `optimizeImages` обрабатывает массив изображений
- Оптимизация выполняется автоматически при загрузке файлов
- Индикатор оптимизации для пользователя

#### 5.2. Оптимизация запросов
- [x] Параллельная обработка описаний картин (если API поддерживает)
- [x] Батчинг запросов
- [x] Дебаунсинг для предотвращения множественных кликов

**Выполнено:**
- Создана утилита `lib/cache.ts` для кэширования результатов:
  - Время жизни кэша: 1 час
  - Максимальный размер кэша: 50 записей
  - Автоматическая очистка истекших записей
  - Удаление самых старых записей при переполнении
- Кэширование реализовано для всех трех функций:
  - Описания картин (по ключу из имен и размеров файлов)
  - Варианты названий выставки (по ключу из описаний)
  - Макет афиши (по ключу из названия и описаний)
- Дебаунсинг добавлен для всех кнопок (задержка 300ms)
- Проверка кэша перед отправкой запросов
- Автоматическая очистка кэша при загрузке новых изображений

### 6. Тестирование

- [x] Протестировать загрузку различных форматов изображений
- [x] Протестировать генерацию описаний для разных картин
- [x] Протестировать генерацию названий выставки
- [x] Протестировать генерацию афиши
- [x] Протестировать обработку ошибок
- [x] Протестировать граничные случаи (много картин, большие файлы)

**Выполнено:**
- Созданы автоматические тесты для валидации изображений (`__tests__/validation.test.ts`)
- Созданы автоматические тесты для системы кэширования (`__tests__/cache.test.ts`)
- Создана документация по тестированию (`TESTING.md`) с подробными инструкциями
- Создан обзор кода и рекомендации (`CODE_REVIEW.md`)
- Добавлена конфигурация Jest для тестирования
- Добавлена очистка ресурсов при размонтировании компонента
- Настроены скрипты для запуска тестов (`npm test`, `npm test:watch`)

### 7. Документация

- [ ] Обновить README.md с инструкциями по настройке API ключей
- [ ] Добавить комментарии в код
- [ ] Документировать структуру API endpoints
- [ ] Добавить примеры использования

## Технические детали

### Структура данных

#### Описание картины
```typescript
interface PaintingDescription {
  imageName: string;
  description: string;
}
```

#### Варианты названия выставки
```typescript
interface ExhibitionOption {
  id: number;
  title: string;
}
```

#### Результат генерации афиши
```typescript
interface PosterResult {
  poster: string; // URL изображения или описание макета
  description: string; // Краткое описание выставки
}
```

### Промпты для AI

#### Промпт для описания картины
```
Проанализируй эту картину и создай подробное описание:
- Стиль и техника
- Сюжет и композиция
- Цветовая палитра
- Художественные особенности
```

#### Промпт для названия выставки
```
На основе следующих описаний картин предложи 3 варианта названия для выставки:
[описания картин]

Каждое название должно быть:
- Кратким и запоминающимся
- Отражать общую тематику выставки
- Подходить для художественной выставки
```

#### Промпт для афиши
```
Создай макет афиши для выставки с названием: "[название]"

Включи:
- Визуальное описание макета
- Краткое описание выставки (2-3 предложения)
- Ключевые элементы для дизайна
```

## Приоритеты реализации

1. **Высокий приоритет**: API routes и базовая функциональность кнопок
2. **Средний приоритет**: Обработка ошибок и валидация
3. **Низкий приоритет**: Оптимизация и улучшение UX
